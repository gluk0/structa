# Structa Sidecar Helm Chart

A Helm chart for deploying a microservice with Structa as a sidecar container for log parsing and structuring.

## Introduction

This Helm chart deploys a microservice along with Structa, a lightweight Python library that transforms unstructured log data into structured data. Structa runs as a sidecar container that watches the logs generated by the main microservice and processes them according to the configured patterns.

## Prerequisites

- Kubernetes 1.16+
- Helm 3.0+
- A running K3s/Kubernetes cluster

## Installation

```bash
# Clone the repository
git clone https://github.com/yourorg/structa-helm-chart.git
cd structa-helm-chart

# Install the chart with the release name "my-release"
helm install my-release ./structa-helm-chart
```

Or to use custom values:

```bash
helm install my-release ./structa-helm-chart -f custom-values.yaml
```

## Configuration

The following table lists the configurable parameters of the chart and their default values.

### Microservice Configuration

| Parameter | Description | Default |
|-----------|-------------|---------|
| `microservice.name` | Name of the microservice | `example-microservice` |
| `microservice.image.repository` | Docker image repository | `nginx` |
| `microservice.image.tag` | Docker image tag | `stable` |
| `microservice.image.pullPolicy` | Image pull policy | `IfNotPresent` |
| `microservice.resources` | CPU/Memory resource requests/limits | See `values.yaml` |
| `microservice.port` | Container port | `80` |
| `microservice.livenessProbe.enabled` | Enable liveness probe | `true` |
| `microservice.livenessProbe.path` | Path for liveness probe | `/` |
| `microservice.readinessProbe.enabled` | Enable readiness probe | `true` |
| `microservice.readinessProbe.path` | Path for readiness probe | `/` |

### Structa Sidecar Configuration

| Parameter | Description | Default |
|-----------|-------------|---------|
| `structa.enabled` | Enable Structa sidecar | `true` |
| `structa.image.repository` | Docker image repository | `structa` |
| `structa.image.tag` | Docker image tag | `latest` |
| `structa.image.pullPolicy` | Image pull policy | `IfNotPresent` |
| `structa.resources` | CPU/Memory resource requests/limits | See `values.yaml` |
| `structa.logPath` | Path to log files to monitor | `/var/log/microservice` |
| `structa.logPatternType` | Type of log pattern | `template` |
| `structa.config` | Structa configuration | See `values.yaml` |
| `structa.destination.type` | Destination type | `filesystem` |
| `structa.destination.config` | Destination configuration | See `values.yaml` |

### Service Configuration

| Parameter | Description | Default |
|-----------|-------------|---------|
| `service.type` | Kubernetes service type | `ClusterIP` |
| `service.port` | Service port | `80` |

### Other Parameters

| Parameter | Description | Default |
|-----------|-------------|---------|
| `podAnnotations` | Annotations for pod template | `{}` |
| `volumes.logs.enabled` | Enable log volume | `true` |
| `volumes.logs.type` | Type of volume | `emptyDir` |
| `volumes.logs.size` | Size limit for volume | `100Mi` |
| `nodeSelector` | Node selector labels | `{}` |
| `tolerations` | Pod tolerations | `[]` |
| `affinity` | Pod affinity | `{}` |

## Custom Configuration

### Using Cloud Storage

To use Google Cloud Storage for log destination:

```yaml
structa:
  destination:
    type: gcs
    config:
      bucket_name: my-bucket
      project_id: my-project
```

You'll also need to create a Kubernetes secret for GCS credentials:

```bash
kubectl create secret generic my-release-gcs-credentials \
  --from-file=credentials.json=/path/to/service-account.json
```

## Troubleshooting

If you encounter issues:

1. Check pod status: `kubectl get pods`
2. Check logs: `kubectl logs <pod-name> -c structa-sidecar`
3. Verify the configmap: `kubectl get configmap my-release-structa-config -o yaml`

## License

This chart is licensed under the MIT License. 